---
lab:
    title: '11 - Azure SQL Database のセキュリティ保護'
    module: 'モジュール 03 - データとアプリケーションのセキュリティ保護'
---

# 課題 11: Azure SQL データベースのセキュリティ保護
# 受講生用ラボ マニュアル

## ラボのシナリオ

Azure SQL データベースのセキュリティ機能を確認するように求められました。具体的には、次のことに関心があります。

- SQL インジェクションやデータ流出などの攻撃に対する保護。 
- データベース情報を検出し、機密などのカテゴリに分類する機能。 
- データベース サーバーとデータベース クエリを監査し、イベントをログに記録する機能。 

> このラボのすべてのリソースについて、**米国東部** リージョンを使用しています。クラスに使用する地域であることを講師に確認します。 

## ラボの目的

このラボでは、次の演習を行います。

- 演習 1: SQL Database のセキュリティ機能を実装する

## ラボ ファイル:

- **\\Allfiles\\Labs\\11\\azuredeploy.json**

### 演習 1: SQL Database のセキュリティ機能を実装する

### 予想時間: 30 分

この演習では、次のタスクを行います。

- タスク 1: Azure SQL データベースのデプロイ
- タスク 2: 高度なデータ保護の構成
- タスク 3: データ分類を構成する
- タスク 4: 監査の構成

#### タスク 1: Azure SQL データベースのデプロイ

このタスクでは、テンプレートを使用してラボ インフラストラクチャを展開します。 

1. Azure portal **`https://portal.azure.com/`** にサインインします。

    >**注**: このラボで使用している Azure サブスクリプションで所有者ロールまたは共同作成者ロールを持つアカウントを使用して Azure ポータルにサインインします。

1. Azure portal で Azure portal ページの上部にある **「リソース、サービス、ドキュメントの検索」** テキスト ボックスで、**「カスタム テンプレートのデプロイ」** と入力し、**「Enter」** キーを押します。

1. **Custom deployment** ブレードで、**エディターで独自のテンプレートをビルド** のオプションをクリックします。

1. **「テンプレートの編集」** ブレードで、**「ファイルの読み込み」** をクリックし、**\\Allfiles\\Labs\\11\\azuredeploy.json** ファイルを見つけて、**「開く」** をクリックします。

    >**注**: テンプレートの内容を確認し、Azure SQL データベースをデプロイしていることを確認します。

1. **「テンプレートの編集」** ブレードで、**「保存」** をクリックします。

1. **「カスタム デプロイ」** ブレードで、次の設定が構成されていることを確認します (既定値を使用して他の設定を行います)。

   |設定|値|
   |---|---|
   |サブスクリプション|このラボで使用する Azure サブスクリプションの名前|
   |リソース グループ| **「新規作成」** をクリックして、名前 **AZ500LAB11** を入力します。|
   |場所| **(US) 米国東部** |

1. [**確認および作成**] をクリックし、[**作成**] をクリックします。

    >**注**: デプロイが完了するのを待ちます。 

#### タスク 2: 高度なデータ保護の構成

1. Azure portal の、Azure portal ページの上部にある **「リソース、サービス、ドキュメントの検索」** テキスト ボックスで、 **「リソース グループ」**と入力し、**「Enter」** キーを押します。

1. **「リソース グループ」** ブレードのリソース グループの一覧で、**「AZ500LAB11」** エントリをクリックします。

1. **「AZ500LAB11」** ブレードで、新しく作成された SQL サーバーを表すエントリをクリックします。

1. サーバー ブレードの **「セキュリティ」** セクションで、**「セキュリティ センター」** をクリック します。

1. **「Azure Defender for SQL の有効化」** をクリックします。

    >**注**: Azure Defender for SQL の有効化タスクが完了するまで待ちます

1. **「Azure Defender for SQL: Enabled at the server-level (Configure)」** をクリックします。 

1. **「サーバー設定」** ブレードで、脆弱性評価の設定とADVANCED THREAT PROTECTION 設定を確認して、**「保存」** をクリックします。

1. **「セキュリティ センター」** ブレードに戻り、推奨事項や

1. **「ストレージ アカウントの作成」** ブレードの、**「名前」** ボックスに、小文字と数字を含む 3 ~ 24 文字のグローバルな一意の名前を入力し、**「OK」** をクリックします。その後、 **「Advanced Data Security」** ペインで **「保存」** をクリックします。

    >**注**: ストレージ コンテナーのパスが無効であるというエラーメッセージを受信した場合、ストレージ アカウントがまだプロビジョニングされていない可能性があります。数分待ってから、**「ストレージ アカウント」** をクリックし、**「ストレージ アカウントの選択」** ブレードで新しく作成したストレージ アカウントを選択し、**「Advanced Data Security」** ペインで、**「保存」** をクリックします。

#### タスク 3: データ分類を構成する

このタスクでは、GPDR とデータ保護のコンプライアンスに関する SQL Database 内の情報を検出し、分類します。

1. サーバー ブレードの **「設定」** セクションで、**「SQL データベース」** をクリックします。

1. ポリシーの一覧で、 **「AZ500LabDb」** エントリを選択します。 

1. 「**AZ500LabDb** SQL Database」 ブレードの **「セキュリティ」** セクションで、**「Advanced Data Security」** をクリックします。

1. 「Advanced Data Security」 ブレードで、**「 データ検出と分類」** タイルをクリックします。 

1. **「データ検出と分類」** ブレードで、**「分類」** タブをクリックします。   

    >**注**: 分類エンジンは、データベースをスキャンして、機密性が高い可能性のあるデータを含んだ列を探し、推奨される列分類の一覧を提示します。

1. ブレードの上部にある青いバーに表示されたテキスト メッセージ **「分類の推奨事項が指定された 15 個の列が見つかりました」** をクリックします。 

1. リストされた列と推奨される機密ラベルを確認します。 

1. **「すべて選択」** チェック ボックスをオンにし、**「選択した推奨事項を受け入れる」** をクリックします。   

    >**注**: または、特定の列だけを選択して他の列を無視することができます。 

    >**注**: 情報タイプと機密ラベルを変更することもできます。 

1. レビューが完了したら、 **「保存」** をクリックします。  

    >**注**: これで分類が完了し、データベース列に新しい分類メタデータが永続的にラベル付けされます。 

1. 「Advanced Data Security」 ブレードに戻って、**「データ検出と分類」** タイルに最新の分類情報が反映されていることに注意してください。 

#### タスク 4: 監査を構成する 

このタスクでは、まずサーバー レベルの監査を構成し、次にデータベース レベルの監査を構成します。 

1. Azure portal で、「SQL Server」 ブレードに戻ります。

1. 「SQL Server」 ブレードの **「セキュリティ」** セクションで、**「監査」** をクリックします。

    >**注**: これはサーバー レベルの監査です。既定の監査設定には、データベースに対して実行されたすべてのクエリとストアド プロシージャ、およびログインの成功と失敗が含まれます。

1. 監査を有効にするには、**「監査」** スイッチを **「ON」** に設定します。    

1. **「Storage」** チェックボックスをオンにし、**「容量の詳細」** をクリックします。    

1. **「記憶域設定」** ブレードで、**「ストレージ アカウント」** をクリックします。

1. **「ストレージ アカウントの作成」** ブレードの **「名前」** ボックスに、小文字と数字を含めた 3 ~ 24 文字のグローバルな一意の名前を入力し、**「OK」** をクリックします。      

1. **「記憶域設定」** ブレードに戻り、**「保存期間 (日)」** を **「5」** に設定し、**「OK」** をクリックします。 

1. 「監査」 ブレードに戻り、**「保存」** をクリックして監査の設定を保存します。 

    >**注**: ストレージ コンテナーのパスが無効な場合、ストレージ アカウントがまだプロビジョニングされていない可能性があります。数分待ってから、**「ストレージ アカウント」** をクリックし、**「ストレージ アカウントの選択」** ブレードで新しく作成したストレージ アカウントを選択し、「監査」 ブレードで **「保存」** をクリックします。

1. サーバー ブレードの **「設定」** セクションで、**「SQL データベース」** をクリックします。

1. データベースの一覧で、 **「AZ500LabDb」** エントリを選択します。 

1. 「**AZ500LabDb** SQL データベース」 ブレードの **「セキュリティ」** セクションで、**「監査」** をクリックします。 

    >**注**: これはデータベース レベルの監査です。サーバー レベルの監査は既に有効になっています。 
  
    >**注**: 監査は、Azure ストレージ アカウント、Log Analytics ワークスペース、またはイベント ハブに書き込むことができます。これらのオプションは、任意に組み合わせて構成できます。

    >**注**: サーバーでストレージベースの監査が有効になっている場合、データベースの設定に関係なく、常にデータベースに適用されます。

1. **「監査ログの表示」** をクリックします。

1. **「監査レコード」** ブレードで、サーバー監査とデータベース監査を切り替えることができることに注意してください。 

    >**注**: この SQL サーバーとデータベースは最近作成されたため、この時点でイベントが利用できることはほとんどありません。 

> 結果: SQL サーバーとデータベースを作成し、データ分類を構成し、監査を行いました。 


**リソースをクリーン アップします**

> Azure リソースのうち、使用しないリソースは必ず削除してください。使用していないリソースを削除することで、予期しないコストが発生しなくなります。 

1. Azure portal から、Azure portal の右上にあるアイコンをクリックして、 Cloud Shell を開きます。メッセージが表示されたら、**PowerShell** と**保存スペースの作成**をクリックします。   

1. 「Cloud Shell」 ウィンドウの左上隅にあるドロップダウン メニューで 「**PowerShell**」 が選択されていることを確認します。 

1. 「Cloud Shell」 ウィンドウ内の 「PowerShell」 セッションで、次の手順を実行して、このラボで作成したリソース グループを削除します。
  
    ```powershell
    Remove-AzResourceGroup -Name "AZ500LAB11" -Force -AsJob
    ```
1. **「Cloud Shell」** ペインを閉じます。 
